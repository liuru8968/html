<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>打工排班日曆 (雲端同步版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { 
            font-family: 'Noto Sans TC', sans-serif; 
            -webkit-tap-highlight-color: transparent;
        }
        .active-day { outline: 2px solid #6366f1; outline-offset: -2px; }
        .holiday-text { color: #ef4444 !important; font-weight: bold; }
        select {
            -webkit-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 0.5rem center;
            background-size: 1em;
        }
        .day-cell:active {
            background-color: #f3f4f6;
        }
        #loading-overlay {
            backdrop-filter: blur(4px);
            transition: opacity 0.3s;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen pb-12">

    <!-- 載入中遮罩 -->
    <div id="loading-overlay" class="fixed inset-0 bg-white/80 z-50 flex flex-col items-center justify-center">
        <div class="animate-spin rounded-full h-12 w-12 border-4 border-indigo-600 border-t-transparent"></div>
        <p class="mt-4 text-indigo-600 font-medium">同步雲端資料庫中...</p>
    </div>

    <div class="max-w-md mx-auto bg-white shadow-lg min-h-screen relative">
        <!-- 頂部導航 -->
        <header class="bg-indigo-600 p-4 text-white flex justify-between items-center sticky top-0 z-10">
            <div>
                <h1 class="text-xl font-bold">打工薪資計算</h1>
                <div class="flex items-center gap-1">
                    <span id="sync-status-dot" class="w-2 h-2 rounded-full bg-red-400"></span>
                    <p id="user-status-text" class="text-[10px] opacity-80 uppercase tracking-wider">離線中</p>
                </div>
            </div>
            <div class="text-sm font-medium">
                <span id="current-month-display">2026年 01月</span>
            </div>
        </header>

        <!-- 數據總覽 -->
        <div class="p-4 space-y-3">
            <div class="bg-indigo-600 p-4 rounded-2xl text-white shadow-lg shadow-indigo-200">
                <p class="text-xs opacity-80 mb-1">本月預估總合 (含加班與節慶)</p>
                <div class="flex items-baseline gap-2">
                    <span class="text-3xl font-bold" id="monthly-total">$0</span>
                    <span class="text-xs opacity-80" id="overtime-breakdown">(加乘獎金: $0)</span>
                </div>
            </div>
            
            <div class="grid grid-cols-2 gap-3">
                <div class="bg-emerald-50 p-3 rounded-xl border border-emerald-100">
                    <p class="text-[10px] text-emerald-600 font-medium">總淨工時</p>
                    <p class="text-xl font-bold text-emerald-900" id="monthly-hours">0h</p>
                </div>
                <div class="bg-amber-50 p-3 rounded-xl border border-amber-100">
                    <p class="text-[10px] text-amber-600 font-medium">工作天數</p>
                    <p class="text-xl font-bold text-amber-900" id="monthly-days">0天</p>
                </div>
            </div>
        </div>

        <!-- 月份控制器 -->
        <div class="px-4 py-1 flex justify-between items-center">
            <button onclick="changeMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full transition active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7" /></svg>
            </button>
            <button onclick="goTo2026()" class="text-indigo-600 font-medium text-sm active:opacity-60">回到 2026</button>
            <button onclick="changeMonth(1)" class="p-2 hover:bg-gray-100 rounded-full transition active:scale-95">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" /></svg>
            </button>
        </div>

        <!-- 日曆區 -->
        <div class="px-2">
            <div class="grid grid-cols-7 mb-1 text-center text-[10px] font-bold text-gray-400">
                <div class="py-2">日</div><div>一</div><div>二</div><div>三</div><div>四</div><div>五</div><div class="py-2">六</div>
            </div>
            <div id="calendar-days" class="grid grid-cols-7 gap-px bg-gray-100 border border-gray-100 rounded-lg overflow-hidden"></div>
        </div>

        <!-- 編輯區 -->
        <div id="day-detail" class="p-4 mt-4 border-t border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800" id="selected-date-label">選擇日期開始排班</h3>
                <span id="holiday-badge" class="hidden text-[10px] bg-red-100 px-2 py-1 rounded text-red-600 font-bold">國定假日 (雙倍薪)</span>
            </div>

            <div id="no-shift-msg" class="text-center py-10 text-gray-400 italic text-sm border-2 border-dashed border-gray-50 rounded-xl">
                請點擊上方日曆日期進行編輯
            </div>

            <div id="shift-config" class="hidden space-y-4">
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">上班時間</label>
                        <div class="flex gap-1">
                            <select id="start-h" onchange="calculateLaborLogic()" class="w-full border rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                            <select id="start-m" onchange="calculateLaborLogic()" class="w-full border rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                        </div>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">下班時間</label>
                        <div class="flex gap-1">
                            <select id="end-h" onchange="calculateLaborLogic()" class="w-full border rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                            <select id="end-m" onchange="calculateLaborLogic()" class="w-full border rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none"></select>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">休息扣除 (分鐘)</label>
                        <select id="break-minutes" onchange="calculateLaborLogic()" class="w-full border rounded-lg p-2 text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="0">0</option><option value="30">30</option><option value="45">45</option>
                            <option value="60">60</option><option value="90">90</option><option value="120">120</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs text-gray-500 mb-1">當日時薪 ($)</label>
                        <input type="number" id="input-rate" onchange="calculateLaborLogic()" class="w-full border rounded-lg p-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none" value="190">
                    </div>
                </div>

                <div id="labor-calc-panel" class="bg-gray-50 p-3 rounded-xl border border-gray-200 text-xs space-y-1">
                    <div class="flex justify-between"><span>淨工時：</span><span id="calc-net-hours" class="font-bold">0h</span></div>
                    <div id="holiday-extra-row" class="flex justify-between text-red-600 hidden"><span>假日加成：</span><span class="font-bold">× 2.0 (雙倍薪)</span></div>
                    <div class="flex justify-between border-t border-gray-200 mt-1 pt-1 font-bold text-indigo-600">
                        <span>預估薪資：</span><span id="calc-daily-pay" class="text-sm">$0</span>
                    </div>
                </div>

                <button onclick="saveShift()" id="save-btn" class="w-full bg-indigo-600 text-white py-3 rounded-xl font-bold shadow-lg hover:bg-indigo-700 transition active:scale-[0.98]">儲存到雲端</button>
                <button onclick="deleteShift()" id="delete-btn" class="w-full text-red-400 py-1 text-xs active:opacity-60">刪除此筆紀錄</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDK 模組 -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore.js";

        const getFirebaseConfig = () => {
            // 如果是在平台內預覽，優先使用注入的變數
            if (typeof __firebase_config !== 'undefined') {
                return JSON.parse(__firebase_config);
            }
            // 這是您提供的 Firebase 配置
            return {
                apiKey: "AIzaSyCT4kpVMh9fbNqmst_lEBiWxszH-nXyMM4",
                authDomain: "work-664f3.firebaseapp.com",
                projectId: "work-664f3",
                storageBucket: "work-664f3.firebasestorage.app",
                messagingSenderId: "281423916814",
                appId: "1:281423916814:web:a72f7dc9dcfc30fc06715f",
                measurementId: "G-ZQ8DNMXLMD"
            };
        };

        const firebaseConfig = getFirebaseConfig();
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'work-tracker-v1';

        // 核心狀態
        const holidays2026 = ["2026-01-01", "2026-02-16", "2026-02-17", "2026-02-18", "2026-02-19", "2026-02-20", "2026-02-21", "2026-02-28", "2026-04-02", "2026-04-03", "2026-05-01", "2026-06-19", "2026-09-25", "2026-10-10"];
        let currentDate = new Date(2026, 0, 1);
        let selectedDateStr = "";
        let shifts = {};
        let currentUser = null;

        // 初始化驗證
        const startAuth = async () => {
            try {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await signInWithCustomToken(auth, __initial_auth_token);
                } else {
                    await signInAnonymously(auth);
                }
            } catch (e) {
                console.error("Auth Error:", e);
                document.getElementById('user-status-text').innerText = "登入失敗 (請確認啟用匿名登入)";
            }
        };

        onAuthStateChanged(auth, (user) => {
            currentUser = user;
            if (user) {
                document.getElementById('user-status-text').innerText = `已連線 (ID: ${user.uid.substring(0,6)})`;
                document.getElementById('sync-status-dot').classList.replace('bg-red-400', 'bg-emerald-400');
                document.getElementById('loading-overlay').style.opacity = '0';
                setTimeout(() => document.getElementById('loading-overlay').style.display = 'none', 300);

                // 訂閱雲端資料
                const collectionPath = `artifacts/${appId}/users/${user.uid}/shifts`;
                onSnapshot(collection(db, collectionPath), (snapshot) => {
                    shifts = {};
                    snapshot.forEach(doc => {
                        shifts[doc.id] = doc.data();
                    });
                    renderCalendar();
                    updateSummary();
                }, (error) => {
                    console.error("Firestore Subscribe Error:", error);
                });
            }
        });

        startAuth();

        // UI 邏輯與功能函數 (省略部分重複內容以符合長度限制，但邏輯保持完整)
        window.populateDropdowns = () => {
            const hIds = ['start-h', 'end-h'], mIds = ['start-m', 'end-m'];
            hIds.forEach(id => {
                const el = document.getElementById(id);
                for(let i=0; i<24; i++) el.add(new Option(i.toString().padStart(2,'0'), i.toString().padStart(2,'0')));
            });
            mIds.forEach(id => {
                const el = document.getElementById(id);
                for(let i=0; i<60; i+=5) el.add(new Option(i.toString().padStart(2,'0'), i.toString().padStart(2,'0')));
            });
        };

        window.calculateLaborLogic = () => {
            if (!selectedDateStr) return;
            const sH = document.getElementById('start-h').value, sM = document.getElementById('start-m').value;
            const eH = document.getElementById('end-h').value, eM = document.getElementById('end-m').value;
            const breakMins = parseInt(document.getElementById('break-minutes').value) || 0;
            const rate = parseFloat(document.getElementById('input-rate').value) || 0;
            const isHoliday = holidays2026.includes(selectedDateStr);

            const startTime = new Date(`2026-01-01T${sH}:${sM}`);
            let endTime = new Date(`2026-01-01T${eH}:${eM}`);
            if (endTime <= startTime) endTime = new Date(`2026-01-02T${eH}:${eM}`);
            
            let netHours = Math.max(0, (endTime - startTime) / 3600000 - (breakMins / 60));
            let basePay = isHoliday ? Math.min(netHours, 8) * rate * 2 : Math.min(netHours, 8) * rate;
            let otPay = 0;
            if (netHours > 8) {
                let otHours = netHours - 8;
                otPay = (Math.min(otHours, 2) * rate * 1.34) + (Math.max(0, otHours - 2) * rate * 1.67);
            }
            let totalPay = basePay + otPay;

            document.getElementById('calc-net-hours').innerText = `${netHours.toFixed(2)}h`;
            document.getElementById('calc-daily-pay').innerText = `$${Math.round(totalPay).toLocaleString()}`;
            document.getElementById('holiday-extra-row').className = isHoliday ? 'flex justify-between text-red-600' : 'hidden';
            return { netHours, totalPay };
        };

        window.renderCalendar = () => {
            const container = document.getElementById('calendar-days');
            if (!container) return;
            container.innerHTML = '';
            const year = currentDate.getFullYear(), month = currentDate.getMonth();
            document.getElementById('current-month-display').innerText = `${year}年 ${(month + 1).toString().padStart(2, '0')}月`;

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();

            for (let i = 0; i < firstDay; i++) container.innerHTML += '<div class="bg-gray-50 h-16 border-b border-r border-gray-100"></div>';

            for (let day = 1; day <= daysInMonth; day++) {
                const dStr = `${year}-${(month + 1).toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`;
                const isH = holidays2026.includes(dStr), shift = shifts[dStr];
                const dayDiv = document.createElement('div');
                dayDiv.className = `day-cell bg-white h-24 border-b border-r border-gray-100 p-1 cursor-pointer transition relative ${selectedDateStr === dStr ? 'active-day' : ''}`;
                dayDiv.onclick = () => selectDate(dStr);
                dayDiv.innerHTML = `<span class="text-[10px] ${isH ? 'holiday-text' : 'text-gray-400'}">${day}</span>
                    ${shift ? `<div class="mt-1 text-[9px] ${shift.hours > 8 ? 'bg-amber-100 border-amber-200' : 'bg-indigo-50 border-indigo-100'} p-1 rounded border truncate font-bold text-center">$${Math.round(shift.dailyTotal)}</div>` : ''}`;
                container.appendChild(dayDiv);
            }
        };

        window.selectDate = (dateStr) => {
            selectedDateStr = dateStr;
            document.getElementById('selected-date-label').innerText = dateStr.replace(/-/g, '/').substring(5) + " 排班詳情";
            document.getElementById('holiday-badge').className = holidays2026.includes(dateStr) ? 'text-[10px] bg-red-100 px-2 py-1 rounded text-red-600 font-bold' : 'hidden';
            document.getElementById('no-shift-msg').classList.add('hidden');
            document.getElementById('shift-config').classList.remove('hidden');

            const s = shifts[dateStr];
            if (s) {
                const [sh, sm] = s.start.split(':'), [eh, em] = s.end.split(':');
                document.getElementById('start-h').value = sh; document.getElementById('start-m').value = sm;
                document.getElementById('end-h').value = eh; document.getElementById('end-m').value = em;
                document.getElementById('break-minutes').value = s.breakMins;
                document.getElementById('input-rate').value = s.rate;
            } else {
                document.getElementById('start-h').value = '09'; document.getElementById('start-m').value = '00';
                document.getElementById('end-h').value = '18'; document.getElementById('end-m').value = '00';
                document.getElementById('break-minutes').value = '60'; document.getElementById('input-rate').value = '190';
            }
            calculateLaborLogic();
            renderCalendar();
        };

        window.saveShift = async () => {
            if (!currentUser) return;
            const { netHours, totalPay } = calculateLaborLogic();
            if (netHours <= 0) return alert('工時必須大於 0');

            const btn = document.getElementById('save-btn');
            btn.disabled = true; btn.innerText = "同步中...";

            const shiftData = {
                start: `${document.getElementById('start-h').value}:${document.getElementById('start-m').value}`,
                end: `${document.getElementById('end-h').value}:${document.getElementById('end-m').value}`,
                breakMins: parseInt(document.getElementById('break-minutes').value),
                hours: netHours,
                rate: parseInt(document.getElementById('input-rate').value),
                dailyTotal: totalPay,
                updatedAt: new Date().toISOString()
            };

            try {
                const docRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/shifts`, selectedDateStr);
                await setDoc(docRef, shiftData);
                btn.innerText = "雲端已儲存 ✅";
                setTimeout(() => { btn.disabled = false; btn.innerText = "儲存到雲端"; }, 1000);
            } catch (error) {
                console.error("Save Error:", error);
                btn.disabled = false; btn.innerText = "儲存失敗";
            }
        };

        window.deleteShift = async () => {
            if (!currentUser || !selectedDateStr) return;
            if (!confirm('確定要從雲端刪除這筆紀錄嗎？')) return;
            const btn = document.getElementById('delete-btn');
            btn.disabled = true;
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${currentUser.uid}/shifts`, selectedDateStr);
                await deleteDoc(docRef);
                document.getElementById('shift-config').classList.add('hidden');
                document.getElementById('no-shift-msg').classList.remove('hidden');
                selectedDateStr = "";
            } catch (error) {
                console.error("Delete Error:", error);
            } finally {
                btn.disabled = false;
            }
        };

        window.updateSummary = () => {
            let total = 0, hours = 0, bonus = 0, days = 0;
            const prefix = `${currentDate.getFullYear()}-${(currentDate.getMonth()+1).toString().padStart(2,'0')}`;
            for(let d in shifts) {
                if(d.startsWith(prefix)) {
                    total += shifts[d].dailyTotal;
                    hours += shifts[d].hours;
                    days++;
                    let normalPay = shifts[d].hours * shifts[d].rate;
                    if(shifts[d].dailyTotal > normalPay) bonus += (shifts[d].dailyTotal - normalPay);
                }
            }
            document.getElementById('monthly-total').innerText = `$${Math.round(total).toLocaleString()}`;
            document.getElementById('overtime-breakdown').innerText = `(額外加乘: $${Math.round(bonus).toLocaleString()})`;
            document.getElementById('monthly-hours').innerText = `${hours.toFixed(1)}h`;
            document.getElementById('monthly-days').innerText = `${days}天`;
        };

        window.changeMonth = (d) => { currentDate.setMonth(currentDate.getMonth() + d); renderCalendar(); updateSummary(); };
        window.goTo2026 = () => { currentDate = new Date(2026, 0, 1); renderCalendar(); updateSummary(); };

        window.onload = () => {
            populateDropdowns();
            renderCalendar();
        };
    </script>
</body>
</html>
